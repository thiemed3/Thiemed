<?xml version="1.0" encoding="UTF-8"?>
<odoo>

  <template id="fix_studio_subtotal_on_lots"
            inherit_id="studio_customization.web_studio_report_ed_438b6cf4-752d-4a2b-be65-de8126967f4d"
            priority="10000009">

    <xpath expr="//tbody[@class='invoice_tbody']//t[@t-foreach='lotes' and @t-as='linea_lote']/t[@t-set='current_subtotal' and @t-value='current_subtotal + line.price_subtotal']"
           position="replace">
      <t t-if="linea_lote_index == 0">
        <t t-set="current_subtotal" t-value="current_subtotal + line.price_subtotal"/>
      </t>
    </xpath>

    <xpath expr="//tbody[@class='invoice_tbody']//t[@t-foreach='lotes' and @t-as='linea_lote']/t[@t-set='current_subtotal' and @t-value='current_subtotal + line.price_total']"
           position="replace">
      <t/>
    </xpath>
  </template>

  <template id="report_invoice_row_singleloop_over_studio"
            inherit_id="studio_customization.web_studio_report_ed_438b6cf4-752d-4a2b-be65-de8126967f4d"
            priority="10000010">

    <xpath expr="//table[@name='invoice_line_table']//t[@name='account_invoice_line_accountable']"
           position="replace">
      <t t-if="line.display_type == 'product'" name="account_invoice_line_accountable">
        <t t-set="lv" t-value="lotes.get(linea_lote) or {}"/>
        <t t-set="has_lote"
           t-value="bool(lv) and (lv.get('cantidad') or lv.get('nombre') or lv.get('udm'))"/>

        <!-- ===================== CON LOTES ===================== -->
        <t t-if="has_lote">
          <t t-set="qty"        t-value="lv.get('cantidad') or 0.0"/>
          <t t-set="uom"        t-value="lv.get('udm') or (line.product_uom_id and line.product_uom_id.name) or ''"/>
          <t t-set="lot_name"   t-value="lv.get('nombre') or ''"/>
          <t t-set="exp_date"   t-value="lv.get('fecha_vencimiento') or ''"/>
          <t t-set="ratio"      t-value="(lv.get('ratio') or 1.0) or 1.0"/>
          <t t-set="price_comp" t-value="lv.get('precio') if lv.get('precio') is not None else line.price_unit"/>

          <t t-set="unit_price"       t-value="price_comp / (ratio or 1.0)"/>
          <t t-set="discount_factor"  t-value="(1 - (line.discount or 0.0)/100.0)"/>
          <t t-set="subtotal"         t-value="unit_price * qty * discount_factor"/>

          <td name="account_invoice_line_name_ref">
            <span t-esc="lv.get('component_code') or (line.product_id.default_code or '')"/>
          </td>

          <td name="account_invoice_line_name">
            <span t-esc="line.only_name(lv.get('component_name') or line.name)"/>
          </td>

          <td name="td_quantity" class="text-end">
            <span t-esc="('{0:.6f}'.format(qty)).rstrip('0').rstrip('.')"/>
            <t t-if="uom"><span class="ms-1" t-esc="uom"/></t>
          </td>

          <td class="text-end">
            <t t-if="lot_name and lot_name != 'SIN LOTE'"><span t-esc="lot_name"/></t>
          </td>

          <td class="text-center">
            <t t-if="exp_date"><span t-esc="exp_date"/></t>
          </td>

          <td name="td_price_unit"
              t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
            <span class="text-nowrap"
                  t-out="unit_price"
                  t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
          </td>

          <td name="td_discount" t-if="display_discount"
              t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
            <span class="text-nowrap" t-esc="'{:g}%'.format(float(line.discount or 0.0))"/>
          </td>

          <t t-set="taxes" t-value="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_ids])"/>
          <td name="td_taxes"
              t-attf-class="text-start {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }} {{ 'text-nowrap' if len(taxes) &lt; 10 else '' }}">
            <span id="line_tax_ids" t-out="taxes"/>
          </td>

          <td name="td_subtotal" class="text-end">
            <span class="text-nowrap"
                  t-out="subtotal"
                  t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
          </td>
        </t>

        <!-- ===================== SIN LOTES ===================== -->
        <t t-else="">
          <td name="account_invoice_line_name_ref">
            <span t-esc="line.product_id.default_code or ''"/>
          </td>

          <td name="account_invoice_line_name">
            <span t-esc="line.only_name(line.name)"/>
          </td>

          <td name="td_quantity" class="text-end">
            <span t-field="line.quantity"/>
            <t t-if="line.product_uom_id"><span class="ms-1" t-field="line.product_uom_id"/></t>
          </td>

          <td class="text-end"></td>
          <td class="text-center"></td>

          <td name="td_price_unit"
              t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
            <span class="text-nowrap"
                  t-field="line.price_unit"
                  t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
          </td>

          <td name="td_discount" t-if="display_discount"
              t-attf-class="text-end {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }}">
            <span class="text-nowrap" t-esc="'{:g}%'.format(float(line.discount or 0.0))"/>
          </td>

          <t t-set="taxes" t-value="', '.join([(tax.invoice_label or tax.name) for tax in line.tax_ids])"/>
          <td name="td_taxes"
              t-attf-class="text-start {{ 'd-none d-md-table-cell' if report_type == 'html' else '' }} {{ 'text-nowrap' if len(taxes) &lt; 10 else '' }}">
            <span id="line_tax_ids" t-out="taxes"/>
          </td>

          <td name="td_subtotal" class="text-end">
            <span class="text-nowrap"
                  t-field="line.price_subtotal"
                  t-options="{'widget': 'monetary', 'display_currency': o.currency_id}"/>
          </td>
        </t>
      </t>
    </xpath>
  </template>
</odoo>
